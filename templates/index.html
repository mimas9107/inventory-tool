<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸ƒç–‹èˆ‡æˆå“-å€‰å„²ä½ç½®èˆ‡åº«å­˜æŸ¥è©¢ï¼ˆå‹•æ…‹åœ°åœ–ç‰ˆï¼‰</title>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h2, h3 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 5px; margin-bottom: 20px; }
        .query-section { margin-bottom: 40px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 300px; margin-right: 10px; }
        button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        
        .result-box { margin-top: 15px; padding: 15px; border-radius: 6px; background-color: #fff; border: 1px solid #ddd; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }

        /* æŸ¥è©¢çµæœ Grid */
        .grid-header { font-weight: bold; background-color: #e9ecef; padding: 10px; border-radius: 6px 6px 0 0; }
        .location-grid-header, .location-item {
            display: grid;
            /* å®šç¾©äº”å€‹æ¬„ä½çš„å¯¬åº¦æ¯”ä¾‹ï¼šID | åç¨±/ä½ç½® | åº«å­˜é‡ | å–®ä½ */
            grid-template-columns: 1.5fr 3.5fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            align-items: center;
        }
        .location-item {
            border-top: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .location-item:hover { background-color: #e0f7fa; }
        .location-item.selected { background-color: #d1e7dd; border: 1px solid #28a745; }
        .location-id { font-weight: bold; }
        .location-desc { color: #007bff; font-weight: bold; }
        
        /* åœ°åœ–é¡¯ç¤ºå€ */
        .map-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        .map-container {
            flex: 1;
            padding: 10px;
            border: 2px solid #0056b3;
            border-radius: 8px;
            background-color: #ffffff;
            text-align: center;
        }
        .map-container h4 {
            color: #0056b3;
            margin-top: 0;
            padding-bottom: 5px;
        }
        .location-map {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
            display: none; /* é è¨­éš±è—ï¼Œè¼‰å…¥åœ–ç‰‡å¾Œé¡¯ç¤º */
        }
        .detail-map { max-width: 200%; } /* å±€éƒ¨åœ°åœ–æ”¾å¤§ */
        .map-placeholder { padding: 50px 10px; color: #6c757d; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <h2>å¸ƒç–‹èˆ‡æˆå“-å€‰å„²ä½ç½®èˆ‡åº«å­˜æŸ¥è©¢ï¼ˆå‹•æ…‹åœ°åœ–ç‰ˆï¼‰</h2>

    <!-- å€å¡Šä¸€ï¼šè²¨å“ç·¨è™Ÿ ç²¾ç¢ºæŸ¥è©¢ -->
    <div class="query-section">
        <h3>1. ä¾ã€Œè²¨å“ç·¨è™Ÿã€ç²¾ç¢ºæŸ¥è©¢</h3>
        <form id="queryFormId">
            <input type="text" id="product_id" name="product_id" placeholder="è«‹è¼¸å…¥è²¨å“ç·¨è™Ÿ..." required>
            <button type="submit">æŸ¥è©¢ä½ç½®èˆ‡åœ°åœ–</button>
        </form>
        <div id="resultId" class="result-box">
            <p>è«‹è¼¸å…¥è²¨å“ç·¨è™Ÿä¸¦é»æ“ŠæŸ¥è©¢ã€‚</p>
        </div>
    </div>
    
    <!-- å€å¡ŠäºŒï¼šè²¨å“åç¨± é—œéµå­—æ¨¡ç³ŠæŸ¥è©¢ -->
    <div class="query-section">
        <h3>2. ä¾ã€Œè²¨å“åç¨±ã€é—œéµå­—æ¨¡ç³ŠæŸ¥è©¢</h3>
        <form id="queryFormName">
            <input type="text" id="keyword" name="keyword" placeholder="è«‹è¼¸å…¥è²¨å“åç¨±é—œéµå­—..." required>
            <button type="submit">é—œéµå­—æœå°‹èˆ‡åœ°åœ–</button>
        </form>
        <div id="resultName" class="result-box">
            <p>è«‹è¼¸å…¥é—œéµå­—ä¸¦é»æ“Šæœå°‹ã€‚</p>
        </div>
    </div>
    
    <!-- åœ°åœ–é¡¯ç¤ºå€å¡Š (å…±ç”¨ï¼Œç”¨æ–¼é¡¯ç¤ºé»æ“Šçµæœ) -->
    <div id="mapContainerWrapper" class="map-wrapper" style="display: none;">
        
        <!-- ç¸½è¦½åœ°åœ– (Area Map) -->
        <div id="areaMapDisplay" class="map-container">
            <h4 id="areaMapTitle">å€‰åº«ç¸½è¦½å€åŸŸåœ–</h4>
            <div id="areaMapPlaceholder" class="map-placeholder">ç­‰å¾…æŸ¥è©¢æˆ–é»æ“Šçµæœ...</div>
            <img id="areaMapImage" class="location-map" src="" alt="å€‰åº«ç¸½è¦½åœ–">
        </div>

        <!-- å±€éƒ¨åœ°åœ– (Detail Map) -->
        <div id="detailMapDisplay" class="map-container">
            <h4 id="detailMapTitle">å„²ä½å±€éƒ¨æ”¾å¤§åœ– (<span id="detailMapLocation">N/A</span>)</h4>
            <div id="detailMapPlaceholder" class="map-placeholder">æ­¤åœ–å°æ‡‰å–®ä¸€å„²ä½ï¼ˆå¦‚ I2-03ï¼‰çš„å±€éƒ¨æ”¾å¤§æˆªåœ–ã€‚</div>
            <img id="detailMapImage" class="location-map detail-map" src="" alt="å„²ä½å±€éƒ¨æ”¾å¤§åœ–">
        </div>

    </div>
    
</div>

<script>
    const staticMapPath = '/static/maps/'; // åœ–ç‰‡æ ¹ç›®éŒ„
    const mapWrapper = document.getElementById('mapContainerWrapper');
    const areaMapImage = document.getElementById('areaMapImage');
    const detailMapImage = document.getElementById('detailMapImage');
    const areaMapTitle = document.getElementById('areaMapTitle');
    const detailMapTitle = document.getElementById('detailMapTitle');
    const detailMapLocation = document.getElementById('detailMapLocation');

    // ---------------------- åœ°åœ–é¡¯ç¤ºè¼”åŠ©å‡½å¼ ----------------------
    function toggleMapElements(imageEl, placeholderEl, show) {
        if (show) {
            imageEl.style.display = 'block';
            placeholderEl.style.display = 'none';
        } else {
            imageEl.style.display = 'none';
            placeholderEl.style.display = 'block';
        }
    }

    function displayMaps(mapInfo, locationDesc) {
        mapWrapper.style.display = 'flex'; // é¡¯ç¤ºåœ°åœ–å®¹å™¨

        // è™•ç†ç¸½è¦½åœ°åœ– (Area Map)
        const areaMapPlaceholder = document.getElementById('areaMapPlaceholder');
        if (mapInfo.area_map_filename) {
            areaMapImage.src = staticMapPath + mapInfo.area_map_filename;
            areaMapTitle.textContent = `${mapInfo.area_name} ç¸½è¦½å€åŸŸåœ–`;
            toggleMapElements(areaMapImage, areaMapPlaceholder, true);
        } else {
            areaMapTitle.textContent = mapInfo.area_name;
            areaMapPlaceholder.textContent = 'æœªæ‰¾åˆ°è©²å€åŸŸçš„ç¸½è¦½åœ°åœ–æª”æ¡ˆã€‚';
            toggleMapElements(areaMapImage, areaMapPlaceholder, false);
        }

        // è™•ç†å±€éƒ¨ç´°ç¯€åœ°åœ– (Detail Map)
        const detailMapPlaceholder = document.getElementById('detailMapPlaceholder');
        detailMapLocation.textContent = locationDesc;
        detailMapTitle.textContent = `å„²ä½å±€éƒ¨æ”¾å¤§åœ– (${locationDesc})`;

        if (mapInfo.detail_map_filename) {
            detailMapImage.src = staticMapPath + mapInfo.detail_map_filename;
            // ç”±æ–¼ detail_map_filename å°±æ˜¯ LocationDesc.pngï¼Œå³ä½¿æª”æ¡ˆä¸å­˜åœ¨ï¼Œ
            // ç€è¦½å™¨ä¹Ÿæœƒå˜—è©¦è¼‰å…¥ï¼Œå¦‚æœå¤±æ•—æœƒé¡¯ç¤º alt æ–‡æœ¬
            toggleMapElements(detailMapImage, detailMapPlaceholder, true);
        } else {
            detailMapPlaceholder.textContent = 'æ­¤å„²ä½ç„¡å®šç¾©æˆ–ç„¡å°æ‡‰çš„å±€éƒ¨æ”¾å¤§æˆªåœ–ã€‚';
            toggleMapElements(detailMapImage, detailMapPlaceholder, false);
        }
    }
    
    function hideMaps() {
        mapWrapper.style.display = 'none';
    }

    // ---------------------- å€å¡Šä¸€ï¼šè²¨å“ç·¨è™ŸæŸ¥è©¢ (ç²¾ç¢ºæŸ¥è©¢) ----------------------
    document.getElementById('queryFormId').addEventListener('submit', function(e) {
        e.preventDefault();
        const productId = document.getElementById('product_id').value;
        const resultDiv = document.getElementById('resultId');
        hideMaps(); // éš±è—åœ°åœ–
        resultDiv.innerHTML = '<p>æŸ¥è©¢ä¸­...</p>';

        fetch('/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'product_id=' + encodeURIComponent(productId)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let htmlContent = `<p class="success">âœ… è²¨å“ç·¨è™Ÿï¼š<strong>${data.product_id}</strong> æŸ¥è©¢æˆåŠŸï¼</p>`;
                
                if (data.is_multiple) {
                    // å¤šç­†çµæœï¼šåªé¡¯ç¤ºåˆ—è¡¨ï¼Œä¸é¡¯ç¤ºåœ°åœ–
                    htmlContent += '<p style="color:red; font-weight:bold;">ğŸš¨ ç™¼ç¾å¤šç­†åº«å­˜ä½ç½®ï¼Œè«‹ä½¿ç”¨åç¨±æŸ¥è©¢çµæœå¾Œé»æ“Šå–®ç­†è¨˜éŒ„ä¾†é¡¯ç¤ºåœ°åœ–ã€‚</p>';
                    // ... (å¤šç­†çµæœçš„åˆ—è¡¨æ¸²æŸ“)
                } else {
                    // å–®ç­†çµæœï¼šé¡¯ç¤ºè©³ç´°è³‡è¨Šä¸¦è¼‰å…¥åœ°åœ–
                    htmlContent += `<p>è²¨å“åç¨±: <strong>${data.product_name}</strong></p>`;
                    htmlContent += `<p>æ‰€åœ¨ä½ç½®: <span class="location-desc">${data.location_desc}</span> (å±¬æ–¼: ${data.area_name})</p>`;
                    htmlContent += `<p>åº«å­˜é‡: <strong>${data.current_qty}</strong> ${data.product_unit}</p>`;
                    
                    // å‘¼å«åœ°åœ–é¡¯ç¤ºå‡½å¼
                    displayMaps(data, data.location_desc);
                }
                resultDiv.innerHTML = htmlContent;
            } else {
                resultDiv.innerHTML = `<p class="error">âŒ æŸ¥è©¢å¤±æ•—: ${data.message}</p>`;
                hideMaps();
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resultDiv.innerHTML = '<p class="error">é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œã€‚</p>';
            hideMaps();
        });
    });

    // ---------------------- å€å¡ŠäºŒï¼šè²¨å“åç¨±é—œéµå­—æŸ¥è©¢ (æ¨¡ç³ŠæŸ¥è©¢) ----------------------
    document.getElementById('queryFormName').addEventListener('submit', function(e) {
        e.preventDefault();
        const keyword = document.getElementById('keyword').value;
        const resultDiv = document.getElementById('resultName');
        hideMaps(); // éš±è—åœ°åœ–
        resultDiv.innerHTML = '<p>æœå°‹ä¸­...</p>';

        fetch('/search_by_name', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'keyword=' + encodeURIComponent(keyword)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let htmlContent = `<p class="success">âœ… é—œéµå­— <strong>'${data.keyword}'</strong> æœå°‹åˆ° <strong>${data.count}</strong> ç­†çµæœï¼Œè«‹é»æ“Šä»»ä¸€é …ç›®æŸ¥çœ‹åœ°åœ–ï¼š</p>`;
                
                // æ¨™é¡Œåˆ—
                htmlContent += `<div class="location-grid-header grid-header"><div>è²¨å“ç·¨è™Ÿ</div><div>è²¨å“åç¨± / å€åŸŸ</div><div>åº«å­˜é‡</div><div>å–®ä½</div></div>`;

                // éæ­·æ‰€æœ‰çµæœ
                data.results.forEach((item) => {
                    // å°‡æ‰€æœ‰åœ°åœ–ç›¸é—œè³‡è¨Šå„²å­˜åˆ° DOM å…ƒç´ çš„ data å±¬æ€§ï¼Œä»¥ä¾¿é»æ“Šæ™‚å–ç”¨
                    htmlContent += `
                        <div class="location-item" 
                             data-location="${item.location_desc}"
                             data-area-name="${item.area_name}"
                             data-area-map="${item.area_map_filename}"
                             data-detail-map="${item.detail_map_filename}">
                            <div class="location-id">${item.product_id}</div>
                            <div>
                                <h4>${item.product_name}</h4>
                                <p>ä½ç½®: <span class="location-desc">${item.location_desc}</span> (${item.area_name})</p>
                            </div>
                            <div class="qty-unit">${item.current_qty}</div>
                            <div class="qty-label">${item.product_unit}</div>
                        </div>
                    `;
                });

                resultDiv.innerHTML = htmlContent;

                // è¨»å†Šé»æ“Šäº‹ä»¶ï¼šé»æ“Šä»»ä¸€çµæœè¡Œï¼Œåœ¨åœ°åœ–å€å¡Šé¡¯ç¤ºå°æ‡‰åœ–ç‰‡
                resultDiv.querySelectorAll('.location-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
                        resultDiv.querySelectorAll('.location-item').forEach(el => el.classList.remove('selected'));
                        this.classList.add('selected'); // æ¨™è¨˜ç•¶å‰é¸ä¸­é …

                        const locationDesc = this.getAttribute('data-location');
                        const mapInfo = {
                            area_name: this.getAttribute('data-area-name'),
                            area_map_filename: this.getAttribute('data-area-map'),
                            detail_map_filename: this.getAttribute('data-detail-map')
                        };
                        
                        displayMaps(mapInfo, locationDesc);
                    });
                });

            } else {
                resultDiv.innerHTML = `<p class="error">âŒ æœå°‹å¤±æ•—: ${data.message}</p>`;
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resultDiv.innerHTML = '<p class="error">é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œã€‚</p>';
        });
    });
</script>

</body>
</html>

